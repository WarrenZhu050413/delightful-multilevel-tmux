#!/bin/bash
# tmux-goto-level - Switch to specific tmux nesting level
# Usage: tmux-goto-level <1-9>

set -euo pipefail

# Configuration - All levels use Ctrl+X prefix
declare -a PREFIXES=("X" "X" "X" "X" "X" "X" "X" "X" "X")
declare -a KEY_TABLES=("root" "level2" "level3" "level4" "level5" "level6" "level7" "level8" "level9")
declare -a PREFIX_KEYS=("C-x" "C-x" "C-x" "C-x" "C-x" "C-x" "C-x" "C-x" "C-x")

# Input validation
validate_level() {
    local level=$1
    if [[ ! $level =~ ^[1-9]$ ]]; then
        tmux display-message "Error: Invalid level '$level' (must be 1-9)"
        return 1
    fi
    return 0
}

# Show error with red status bar
show_error() {
    local message=$1
    tmux set-option -g status-style "fg=colour15,bg=colour196" 2>/dev/null || true
    tmux display-message "$message"
    sleep 1
    tmux set-option -u status-style 2>/dev/null || true
}

# Main function
main() {
    if [[ $# -ne 1 ]]; then
        show_error "Usage: tmux-goto-level <1-9>"
        exit 1
    fi

    local target_level=$1
    
    # Validate input
    if ! validate_level "$target_level"; then
        exit 1
    fi

    # Array indices (0-based)
    local idx=$((target_level - 1))
    
    # Set prefix for target level
    local prefix_key="${PREFIX_KEYS[$idx]}"
    local key_table="${KEY_TABLES[$idx]}"
    local prefix_char="${PREFIXES[$idx]}"
    
    # Apply changes
    if ! tmux set-option -g prefix "$prefix_key" 2>/dev/null; then
        show_error "Error: Failed to set prefix to $prefix_key"
        exit 1
    fi
    
    if ! tmux set-option -g key-table "$key_table" 2>/dev/null; then
        show_error "Error: Failed to set key-table to $key_table"
        exit 1
    fi
    
    # Update current level state
    if ! tmux set-option -g @current_level "$target_level" 2>/dev/null; then
        show_error "Warning: Could not save level state"
    fi
    
    # Refresh clients to update status bar
    tmux refresh-client -S 2>/dev/null || true
    
    # Visual confirmation
    tmux display-message "Level $target_level: Ctrl+$(echo $prefix_char | tr '[:lower:]' '[:upper:]')"
    
    # Save state for persistence
    echo "$target_level" > ~/.tmux_level_state 2>/dev/null || true
}

# Run main function
main "$@"