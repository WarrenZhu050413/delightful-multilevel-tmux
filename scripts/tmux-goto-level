#!/bin/bash
# tmux-goto-level - Switch to specific tmux nesting level
# Usage: tmux-goto-level <1-9>

set -euo pipefail

# Session detection function
detect_session_level() {
    # Check TMUX_LEVEL environment variable (primary method)
    if [[ -n ${TMUX_LEVEL:-} ]]; then
        echo "$TMUX_LEVEL"
    else
        # Default to level 1 if not set
        echo "1"
    fi
}

# Input validation
validate_level() {
    local level=$1
    if [[ ! $level =~ ^[1-9]$ ]]; then
        tmux display-message "Error: Invalid level '$level' (must be 1-9)"
        return 1
    fi
    return 0
}

# Show error with red status bar
show_error() {
    local message=$1
    tmux set-option -g status-style "fg=colour15,bg=colour196" 2>/dev/null || true
    tmux display-message "$message"
    sleep 1
    tmux set-option -u status-style 2>/dev/null || true
}

# Main function - implements active/passthrough pattern
main() {
    if [[ $# -ne 1 ]]; then
        show_error "Usage: tmux-goto-level <1-9>"
        exit 1
    fi

    local target_level=$1
    
    # Validate input
    if ! validate_level "$target_level"; then
        exit 1
    fi
    
    # Get current session's level
    local current_session_level
    current_session_level=$(detect_session_level)
    
    # Step 1: Set ALL sessions to passthrough mode (following 2-level pattern)
    if ! tmux set-option -g prefix None 2>/dev/null; then
        show_error "Error: Failed to set prefix to None"
        exit 1
    fi
    
    if ! tmux set-option -g key-table off 2>/dev/null; then
        show_error "Error: Failed to set key-table to off"
        exit 1
    fi
    
    # Step 2: If current session matches target level, activate it
    if [[ $current_session_level -eq $target_level ]]; then
        # Restore normal tmux operation for this session
        if ! tmux set-option -g prefix C-x 2>/dev/null; then
            show_error "Error: Failed to restore prefix"
            exit 1
        fi
        
        if ! tmux set-option -g key-table root 2>/dev/null; then
            show_error "Error: Failed to set key-table to root"
            exit 1
        fi
        
        # Visual confirmation - this session is now active
        tmux display-message "Level $target_level ACTIVE (session control enabled)"
    else
        # This session is now in passthrough mode
        tmux display-message "Level $target_level active (this session: L$current_session_level passthrough)"
    fi
    
    # Step 3: Update global navigation state
    if ! tmux set-option -g @active_level "$target_level" 2>/dev/null; then
        show_error "Warning: Could not save active level state"
    fi
    
    # Step 4: Refresh clients to update status bar
    tmux refresh-client -S 2>/dev/null || true
    
    # Step 5: Save state for persistence
    echo "$target_level" > ~/.tmux_level_state 2>/dev/null || true
}

# Run main function
main "$@"