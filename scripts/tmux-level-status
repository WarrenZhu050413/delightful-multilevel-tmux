#!/bin/bash
# tmux-level-status - Format level indicator for status bar
# Usage: tmux-level-status [--compact|--full|--minimal|--visual|--help]

set -euo pipefail

# Show help
if [[ ${1:-} == "--help" || ${1:-} == "-h" ]]; then
    cat << 'EOF'
tmux-level-status - Format level indicator for tmux status bar

USAGE:
    tmux-level-status [FORMAT]

FORMATS:
    --compact (default)  [L3:X]
    --full              [L3:Ctrl+X]
    --minimal           [3]
    --visual            [L3:X ●●●○○○○○○]
    --help, -h          Show this help

EXAMPLES:
    # Use in tmux status bar
    set-option -g status-right "#(tmux-level-status --visual) | %l:%M%p"
    
    # Test different formats
    tmux-level-status --compact
    tmux-level-status --visual

COLOR CODING:
    Levels 1-3: Default color (shallow nesting)
    Levels 4-6: Orange (#[fg=colour214]) (medium nesting) 
    Levels 7-9: Red (#[fg=colour196]) (deep nesting warning)

SEE ALSO:
    tmux-level-help     Show navigation commands for current level
    tmux-goto-level     Switch to specific level
    tmux-level-reset    Emergency reset to Level 1
EOF
    exit 0
fi

main() {
    # Get current level, default to 1 if not set
    local current_level
    current_level=$(tmux show-option -gv @current_level 2>/dev/null || echo "1")
    
    # All levels use Ctrl+X prefix
    local prefix_char="X"
    
    # Format options
    local format_type="${1:-compact}"
    local output=""
    
    case "$format_type" in
        --compact|compact)
            output="[L${current_level}:${prefix_char}]"
            ;;
        --full|full)
            output="[L${current_level}:Ctrl+${prefix_char}]"
            ;;
        --minimal|minimal)
            output="[${current_level}]"
            ;;
        --visual|visual)
            # Visual dots with level text: [L3:X ●●●○○○○○○]
            local filled=$(printf "%*s" "$current_level" "" | sed 's/ /●/g')
            local empty=$(printf "%*s" $((9 - current_level)) "" | sed 's/ /○/g')
            output="[L${current_level}:${prefix_char} ${filled}${empty}]"
            ;;
        *)
            # Default to compact
            output="[L${current_level}:${prefix_char}]"
            ;;
    esac
    
    # Color coding for deep nesting (levels 7-9)
    if [[ $current_level -ge 7 ]]; then
        echo "#[fg=colour196]${output}#[default]"  # Red for deep nesting
    elif [[ $current_level -ge 4 ]]; then
        echo "#[fg=colour214]${output}#[default]"  # Orange for medium nesting
    else
        echo "$output"  # Default color for shallow nesting
    fi
}

main "$@"