# ╔══════════════════════════════════════════════════════════════════════════╗
# ║                    DELIGHTFUL MULTILEVEL TMUX (DMT)                       ║
# ║                         Configuration File v2.0                           ║
# ║                                                                            ║
# ║  "One tmux to rule them all, nine levels to bind them"                   ║
# ╚══════════════════════════════════════════════════════════════════════════╝

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                             CORE SETTINGS                                 │
# └──────────────────────────────────────────────────────────────────────────┘

# Primary prefix key (Ctrl+X) - Used by active multilevel sessions
unbind C-x
set -g prefix C-x
bind C-x send-prefix

# Base window indexing starts at 1 (more intuitive)
set -g base-index 1

# Terminal color support
set-option -g default-terminal screen-256color

# Disable repeat time - allow the arrow key to be used immediately after changing windows
set-option -g repeat-time 0

# Disable assume-paste-time so that iTerm2's "Send Hex Codes" feature works
# with tmux 2.1. This is backwards-compatible with earlier versions of tmux.
set-option -g assume-paste-time 0

# Default shell command
set-option -g default-command "$SHELL"

# Store tmux version for compatibility checks
run-shell "tmux setenv -g TMUX_VERSION $(tmux -V | cut -c 6-)"

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                    DELIGHTFUL MULTILEVEL NAVIGATION                       │
# │                         9-Level Tmux System                               │
# └──────────────────────────────────────────────────────────────────────────┘
#
# QUICK REFERENCE:
#   • Direct jumps: Ctrl+X then !@#$%^&*(  → Jump to Levels 1-9
#   • Sequential:   Ctrl+V (down level), Ctrl+B (up level)  
#   • Emergency:    Ctrl+X !  → Reset to Level 1
#   • Help:         Run `tmux-level-help` for current level info
#
# STATUS BAR FORMATS:
#   --visual:   [L3:X ●●●○○○○○○]  ← Current default
#   --compact:  [L3:X]
#   --full:     [L3:Ctrl+X] 
#   --minimal:  [3]

# Initialize multilevel tracking variables
set -g @current_level 1
set -g @max_levels 9

# Direct level jumps using Ctrl+X followed by Shift+1-9 (!@#$%^&*()
bind ! run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 1'
bind @ run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 2'
bind '#' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 3'
bind '$' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 4'
bind % run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 5'
bind '^' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 6'
bind '&' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 7'
bind '*' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 8'
bind '(' run-shell '~/.local/bin/tmux-multilevel/tmux-goto-level 9'

# Sequential navigation bindings
# Ctrl+V = go down one level, Ctrl+B = go up one level (with wraparound)
bind -T root C-v run-shell "$HOME/.local/bin/tmux-multilevel/tmux-level-down"
bind -T root C-b run-shell "$HOME/.local/bin/tmux-multilevel/tmux-level-up"

# Off key-table bindings (for passthrough sessions)
# These allow navigation even when session is in passthrough mode
bind -T off C-v run-shell "$HOME/.local/bin/tmux-multilevel/tmux-level-down"
bind -T off C-b run-shell "$HOME/.local/bin/tmux-multilevel/tmux-level-up"

# Note: Ctrl+X Ctrl+X removed to preserve copy-mode binding (see bind-key x copy-mode below)

# Session persistence hook - restores level state on new sessions
set-hook -g session-created 'run-shell "
if [ -f ~/.tmux_level_state ]; then
    level=$(cat ~/.tmux_level_state 2>/dev/null || echo 1)
    ~/.local/bin/tmux-multilevel/tmux-goto-level $level 2>/dev/null || ~/.local/bin/tmux-multilevel/tmux-level-reset
fi"'

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                         WINDOW MANAGEMENT                                 │
# └──────────────────────────────────────────────────────────────────────────┘

# Window navigation
bind-key space next-window
bind-key bspace previous-window
bind-key a next-window
bind-key A previous-window
bind-key enter next-layout

# Window creation and selection
bind-key c new-window
bind-key t choose-tree -Zs

# Quick config reload
bind-key R source-file ~/.tmux.conf \; display-message "tmux.conf reloaded."

# Command prompt and utilities
bind-key : command-prompt
bind-key r refresh-client
bind-key L clear-history
bind-key q display-panes

# Display panes timeout
set-window-option -g display-panes-time 1500

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                          PANE MANAGEMENT                                  │
# └──────────────────────────────────────────────────────────────────────────┘

# Vim-style pane creation (preserve current path)
bind-key v split-window -h -c "#{pane_current_path}"
bind-key s split-window -v -c "#{pane_current_path}"

# Vim-style pane navigation
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Quick pane switching
bind-key ' ' last-pane

# Layout management
bind-key H select-layout even-horizontal
bind-key V select-layout even-vertical
bind-key + select-layout main-horizontal
bind-key = select-layout main-vertical
bind-key C-o rotate-window

# Synchronize panes toggle (Shift+S)
bind-key S setw synchronize-panes \; display-message "Pane sync: #{?pane_synchronized,ON,OFF}"

# Main pane dimensions for main-horizontal/vertical layouts
set-window-option -g other-pane-height 25
set-window-option -g other-pane-width 80

# Smart pane switching with vim awareness
# Seamlessly navigate between vim splits and tmux panes
bind -n C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-h) || tmux select-pane -L"
bind -n C-j run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-j) || tmux select-pane -D"
bind -n C-k run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-k) || tmux select-pane -U"
bind -n C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys C-l) || tmux select-pane -R"
bind -n 'C-\' run "(tmux display-message -p '#{pane_current_command}' | grep -iqE '(^|\/)vim$' && tmux send-keys 'C-\\') || tmux select-pane -l"
bind C-l send-keys 'C-l'

# Force immediate reflow when panes are resized
set -g aggressive-resize on

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                        COPY MODE & CLIPBOARD                              │
# └──────────────────────────────────────────────────────────────────────────┘

# Vi-style copy mode
setw -g mode-keys vi

# Enter copy mode with 'x', paste with 'p'
bind-key x copy-mode
bind-key p paste-buffer

# Vi-style selection and copy (macOS pbcopy integration)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
unbind -T copy-mode-vi Enter
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# Mouse drag to copy
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Rectangle selection (Ctrl+R in copy mode, avoiding conflict with Ctrl+V)
bind-key -T copy-mode-vi C-r send-keys -X rectangle-toggle

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                         STATUS BAR & APPEARANCE                           │
# └──────────────────────────────────────────────────────────────────────────┘

# Status bar configuration
set-option -g status-interval 1
set-option -g status-left ''

# Multilevel navigation status with visual indicator
# Shows: [L3:X ●●●○○○○○○] format with color coding
# Run `tmux-level-status --help` for format options
set-option -g status-right "#(~/.local/bin/tmux-multilevel/tmux-level-status --visual) #{?client_prefix,[ACTIVE],} | %l:%M%p"

# Window status styling
set-window-option -g window-status-current-style fg=magenta
set-option -g status-style fg=default

# Color scheme: Solarized Dark (default)
set-option -g status-style bg=black
set-option -g pane-active-border-style fg=colour215,bold
set-option -g pane-border-style fg=colour238

# Color scheme: Solarized Light (auto-detect based on terminal)
if-shell "[ \"$COLORFGBG\" = \"11;15\" ]" "set-option -g status-style bg=white"
if-shell "[ \"$COLORFGBG\" = \"11;15\" ]" "set-option -g pane-active-border-style fg=colour215,bold"
if-shell "[ \"$COLORFGBG\" = \"11;15\" ]" "set-option -g pane-border-style fg=colour250"

# Window activity notifications
setw -g monitor-activity on
set -g visual-activity on

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                            MOUSE SUPPORT                                  │
# └──────────────────────────────────────────────────────────────────────────┘

# Enable mouse support for pane selection, resizing, and scrolling
set -g mouse on

# Fix to allow mousewheel/trackpad scrolling in tmux 2.1
bind-key -T root WheelUpPane if-shell -F -t = "#{alternate_on}" "send-keys -M" "select-pane -t =; copy-mode -e; send-keys -M"
bind-key -T root WheelDownPane if-shell -F -t = "#{alternate_on}" "send-keys -M" "select-pane -t =; send-keys -M"

# ┌──────────────────────────────────────────────────────────────────────────┐
# │                         MISCELLANEOUS SETTINGS                            │
# └──────────────────────────────────────────────────────────────────────────┘

# Unbind Shift+Enter to prevent accidental pane switching
unbind -n S-Enter

# ╔══════════════════════════════════════════════════════════════════════════╗
# ║                          END OF CONFIGURATION                             ║
# ║                                                                            ║
# ║  For more information:                                                    ║
# ║  • Run: tmux-level-help                                                   ║
# ║  • Visit: https://github.com/WarrenZhu050413/delightful-multilevel-tmux   ║
# ╚══════════════════════════════════════════════════════════════════════════╝